---
title: "Workshop 19_11_07"
author: "Stefan Haußner"
date: "6 November 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r results = 'hide', message=FALSE, warning=FALSE}
library(openxlsx)
library(tidyverse)
library(janitor)
library(countrycode)
library(igraph)
library(ggrepel)
library(ggthemes)
```



```{r}
load("../data/data_preprocessed.Rdata")
```

# Combining network data with supplementary data

dass wir unsere Daten in Zusammenhang mit unseren grundlegenden Annahmen und Thesen stellen

* hierzu haben wir zwei grobe Themenblöcke definiert
    * Wirtschaftliche Beziehungen
    * Sozio-kulturelle Verbindungen
* Um die These(n) zu prüfen haben wir unabhängige Variablen definiert (siehe Tabelle im Protokoll)

I. Wirtschaftliche Beziehungen

  * Gesamthandelsvolumen (Jonas)
  * FDI (Nastja)
  
II. Sozio-kulturelle Verbindungen

  * Remittances (Arbeitsmigration) (Yunus)
  * Botschaften (Fedor)
  * EU-Bürger_innen in Drittstaaten (Arbeitsmigration) (Katharina)

## Datenaufbereitung Turnover Jonas

```{r}
turnover_raw <- openxlsx::read.xlsx("../data/19_Turnover_Jonas_nicht_zugeordnet_10-30.xlsx", 
                                    sheet = 1, startRow = 12, na.strings = "not available") %>% 
  tbl_df() %>% 
  clean_names() %>% 
  rename(belgium = belgium_and_luxbg_1998,
         czechia = czechia_cs_1992,
         germany = germany_incl_dd_from_1991) %>% 
  select(partner_reporter:slovakia, croatia) %>% 
  filter(!(row_number() %in% 273:280))

turnover_prepared <- turnover_raw %>% 
  gather(austria:croatia, key = country, value = value) %>% 
  mutate(iso_host = countrycode(sourcevar = partner_reporter, origin = "country.name", "iso3c"),
         iso_guest = countrycode(sourcevar = country, origin = "country.name", "iso3c"),
         value = round(value, 6))
```

# Preparing supplementary data for merging with network-graph

Some of the rows are not "unique", because i.e. there are two observations for DNK and RUS (Russian Federation and Soviet Union). Filtering through a mark for "unique" AND value over 0 OR EQUAL.

```{r}

turnover_prepared_2 <- left_join(rd_ready, turnover_prepared, by = c("iso3_eu" = "iso_guest", "iso3_host" = "iso_host")) %>% 
  select(iso3_eu, iso3_host, value, partner_reporter) %>%
  group_by(iso3_eu, iso3_host) %>% 
  arrange(value, .by_group = TRUE) %>% 
  mutate(n = n(),
         lag = value - lag(value)) %>% 
  mutate(filter_mark = (n > 1 & lag == 0),
         filter_mark = case_when(is.na(filter_mark) ~ FALSE,
                                 TRUE ~ filter_mark)) %>% 
  filter(filter_mark == FALSE, !is.na(value)) %>% 
  ungroup() %>% 
  group_by(iso3_eu, iso3_host) %>% 
  arrange(value, .by_group = TRUE) %>% 
  mutate(n = n()) %>% 
  filter(n == 1 | (n > 1 & lag > 0))

turnover_network_data <- left_join(rd_ready, turnover_prepared_2, by = c("iso3_eu", "iso3_host")) %>% 
  select(iso3_eu, iso3_host, turnover = value)

```


# Regionendossiers

## Extrahieren von Regionen aus dem Gesamtnetzwerk

```{r}

#countries_of_interest <- c("BLZ", "CRI","SLV","GTM","HND","MEX","NIC","PAN")
countries_of_interest <- c("CHN", "HKG","JPN","PRK","KOR","MAC","MNG")


rd_region <- rd_ready %>% 
  filter(iso3_host %in% countries_of_interest) %>% 
  graph.data.frame(directed = FALSE)

V(rd_region)$type <- V(rd_region)$name %in% countries_of_interest

plot.igraph(rd_region, vertex.color = V(rd_region)$type)
```

## Layouten

tbc.

## Analyse

### Bipartite Projektion der EU28

```{r}
rd_projection <- bipartite.projection(rd_region)
rd_projection_eu <- rd_projection$proj1

plot.igraph(rd_projection_eu, edge.width = E(rd_projection_eu)$weight)

```


```{r}
source("../scripts/bipartite_closeness_centrality.R")

#bipartite_closeness_centrality(rd_igraph)

bipartite_closeness_centrality(rd_region) %>% unlist() %>% unname() %>% round(3) %>% tbl_df() %>% 
  mutate(name = V(rd_region)$name,
         type = case_when(V(rd_region)$type == FALSE ~ "eu",
                          TRUE ~ "non-eu")) %>% 
  select(name, closeness_centrality = value, type) %>%
  arrange(type, closeness_centrality)


```

Gleiches gilt für die Betweenness-Zentralität.

> Erinnerung ```Betweenness```: Ausmaß, in dem ein Knoten auf Pfaden zwischen anderen Knoten liegt.

```{r}
source("../scripts/bipartite_betweenness_centrality.R")

#bipartite_betweenness_centrality(rd_igraph)

bipartite_betweenness_centrality(rd_region) %>% unlist() %>% unname() %>% round(3) %>% tbl_df %>% 
  mutate(name = V(rd_region)$name,
         type = case_when(V(rd_region)$type == FALSE ~ "eu",
                          TRUE ~ "non-eu")) %>% 
  select(name, betweenness_centrality = value, type) %>%
  arrange(type, -betweenness_centrality)
```


# Verknüpfung von supplementary data mit Regionen

```{r}
turnover_in_region <- turnover_network_data %>% 
  filter(iso3_host %in% countries_of_interest) %>% 
  group_by(iso3_eu) %>% 
  summarise(turnover_in_region = sum(turnover))

region_eigen <- eigen_centrality(rd_projection_eu, weights = E(rd_projection_eu)$weight)$vector %>% 
  data.frame() %>% 
  rownames_to_column(var = "iso3_eu") %>% 
  rename(eigenvector_centr = ".")

region_strength <- strength(rd_projection_eu) %>% 
  data.frame() %>% 
  rownames_to_column(var = "iso3_eu") %>% 
  rename(strength = ".")

region_dataset <- left_join(region_eigen, region_strength, by = "iso3_eu") %>% 
  left_join(., turnover_in_region, by = "iso3_eu")


ggplot(region_dataset, aes(x = turnover_in_region, y = eigenvector_centr))+
  #geom_smooth(method = "lm", alpha = 0.2)+
  geom_point()+
  geom_text_repel(aes(label = iso3_eu))+
  theme_minimal(base_size = 14)+
  labs(x = "turnover in region (%)",
       y = "eigenvector centrality")
  

```

